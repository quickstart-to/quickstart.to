---
import QuickstartLayout from '@layouts/QuickstartLayout.astro';
import {
  getAllQuickstarts,
  getQuickstartById,
  getAvailableVariants,
} from '@utils/content';
import { DEFAULT_VARIANT } from '@utils/variant';

export async function getStaticPaths() {
  const quickstarts = await getAllQuickstarts();
  const paths: { params: { id: string }; props: { contentId: string; variant: string } }[] = [];

  // Collect all unique IDs and their variants
  const idMap = new Map<string, string[]>();
  for (const q of quickstarts) {
    if (!idMap.has(q.id)) idMap.set(q.id, []);
    idMap.get(q.id)!.push(q.variant);
  }

  for (const [contentId, variants] of idMap) {
    // Default variant: /docker
    if (variants.includes(DEFAULT_VARIANT)) {
      paths.push({
        params: { id: contentId },
        props: { contentId, variant: DEFAULT_VARIANT },
      });
    }
    // Other variants: /docker/zh
    for (const variant of variants) {
      if (variant !== DEFAULT_VARIANT) {
        paths.push({
          params: { id: `${contentId}/${variant}` },
          props: { contentId, variant },
        });
      }
    }
  }

  return paths;
}

interface Props {
  contentId: string;
  variant: string;
}

const { contentId, variant } = Astro.props;

const quickstart = await getQuickstartById(contentId, variant);

if (!quickstart) {
  return Astro.redirect('/404');
}

const availableVariants = await getAvailableVariants(contentId);
const { Content, headings } = await quickstart.entry.render();

// Construct file path for contributors
const filePath = `src/content/${quickstart.category}/${contentId}/${variant}.md`;
---

<QuickstartLayout
  title={quickstart.entry.data.title}
  description={quickstart.entry.data.description}
  variant={variant}
  category={quickstart.category}
  id={contentId}
  availableVariants={availableVariants}
  headings={headings}
  filePath={filePath}
>
  <Content />
</QuickstartLayout>
